<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script>
// I have like only a few hours of JS experience, most of this was copy-paste
  const labels = ["airplane", "automobile", "bird", "cat", "deer", "dog", "frog", "horse", "ship", "truck"];
  document.addEventListener("DOMContentLoaded", async function () {
    const input = document.getElementById('fileInput');
    const outputDiv = document.getElementById('output');
    // https://imagekit.io/blog/how-to-resize-image-in-javascript/
    if (input) {
      input.addEventListener('change', async function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function(event) {
          const img = new Image();
          img.onload = async function() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, 32, 32); // 32x32 image size
            const imageData = ctx.getImageData(0, 0, 32, 32);

            // https://developer.mozilla.org/en-US/docs/Web/API/ImageData/data
            const inputData = new Float32Array(32 * 32 * 3);
            let index = 0;
            for (let i = 0; i < imageData.data.length; i += 4) {
              inputData[index++] = imageData.data[i] / 255.0;
              inputData[index++] = imageData.data[i + 1] / 255.0;
              inputData[index++] = imageData.data[i + 2] / 255.0;
            }
            
            // https://www.youtube.com/watch?v=Vs730jsRgO8
            const session = await ort.InferenceSession.create('/assets/models/model.onnx');
            const inputTensor = new ort.Tensor('float32', inputData, [1, 3, 32, 32]);
            const feeds = {'input.1': inputTensor};
            const outputMap = await session.run(feeds);
            const outputTensor = outputMap['22'];
            const tensorData = outputTensor.data;

            const maxIndex = 0;
            const maxValue = tensorData[0];

            for (const i = 1; i < tensorData.length; i++) {
              if (tensorData[i] > maxValue) {
                maxValue = tensorData[i];
                maxIndex = i;
              }
            }
            const predictedLabel = labels[maxIndex];
            document.getElementById('output').innerHTML = predictedLabel;
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
        }
      });
    }
  });
</script>