<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script src='https://cdn.plot.ly/plotly-3.0.1.min.js'></script>
<script>
// I have like only a few hours of JS experience, most of this was copy-paste
const labels = ["airplane", "automobile", "bird", "cat", "deer", "dog", "frog", "horse", "ship", "truck"];
document.addEventListener("DOMContentLoaded", async function () {
    const input = document.getElementById('fileInput');
    const outputDiv = document.getElementById('output');
    // https://imagekit.io/blog/how-to-resize-image-in-javascript/
    if (input) {
        input.addEventListener('change', async function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = 32;
                        canvas.height = 32;

                        // this does the shrinking
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 32, 32); // 32x32 image size
                        const imageData = ctx.getImageData(0, 0, 32, 32);

                        const mean = [0.485, 0.456, 0.406];
                        const std  = [0.229, 0.224, 0.225];

                        // https://developer.mozilla.org/en-US/docs/Web/API/ImageData/data
                        const inputData = new Float32Array(32 * 32 * 3);
                        for (let i = 0; i < 32; i++) {
                            for (let j = 0; j < 32; j++) {
                                const pixelIndex = (i * 32 + j) * 4;
                                const r = imageData.data[pixelIndex] / 255.0;
                                const g = imageData.data[pixelIndex + 1] / 255.0;
                                const b = imageData.data[pixelIndex + 2] / 255.0;

                                const idx = i * 32 + j;
                                inputData[idx] = (r - mean[0]) / std[0];
                                inputData[1024 + idx] = (g - mean[1]) / std[1];
                                inputData[2048 + idx] = (b - mean[2]) / std[2];
                            }
                        }

                        // https://www.youtube.com/watch?v=Vs730jsRgO8
                        const session = await ort.InferenceSession.create('/assets/models/model.onnx');
                        const inputTensor = new ort.Tensor('float32', inputData, [1, 3, 32, 32]);
                        const feeds = {'input.1': inputTensor};
                        const outputMap = await session.run(feeds);
                        const outputTensor = outputMap['498'];
                        const tensorData = outputTensor.data;

                        // https://gist.github.com/cyphunk/6c255fa05dd30e69f438a930faeb53fe
                        function softmax(logits) {
                            const highest = Math.max(...logits);
                            const shifted = logits.map(score => Math.exp(score - highest));
                            const total = shifted.reduce((acc, val) => acc + val, 0);
                            return shifted.map(prob => (prob / total) * 100);
                        }

                        predictions = softmax(tensorData)

                        let maxIndex = 0;
                        let maxValue = tensorData[0];

                        for (let i = 1; i < predictions.length; i++) {
                            if (predictions[i] > maxValue) {
                                maxValue = predictions[i];
                                maxIndex = i;
                            }
                        }
                        const predictedLabel = labels[maxIndex];
                        const predictedConf = predictions[maxIndex].toFixed(2);

                        var data = [{
                            type: 'bar',
                            x: labels,
                            y: predictions
                        }];

                        document.getElementById('output').innerHTML = `I am guessing <strong>${predictedLabel}</strong> was your image with ${predictedConf}% confidence!`;

                        Plotly.newPlot('barChart', data, {autosize: true, margin: {t: 0, b: 30, l: 30, r: 10}}, {displayModeBar: false});
                    };
                img.src = event.target.result;
                };
            reader.readAsDataURL(file);
            }
        });
    }
});
</script>